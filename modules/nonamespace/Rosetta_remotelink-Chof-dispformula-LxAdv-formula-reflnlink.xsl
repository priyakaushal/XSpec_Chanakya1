<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:dita="http://dita.oasis-open.org/architecture/2005/" xmlns:ref="http://www.lexisnexis.com/xmlschemas/content/shared/reference/1/" version="2.0" exclude-result-prefixes="dita">

	<dita:topic xmlns="http://dita.oasis-open.org/architecture/2005/" id="Rosetta_remotelink-Chof-dispformula-LxAdv-formula-reflnlink">
    <title><sourcexml>dispformula/remotelink</sourcexml> to <targetxml>formula/ref:lnlink</targetxml> <lnpid>id-CCCC-10527</lnpid></title>
    <body>
        <section>
            <p>If <sourcexml>remotelink@service="DOC-ID"</sourcexml> encounter inside the
                    <sourcexml>dispformula</sourcexml> markup in source document, then it should be
                converted as <sourcexml>formula/ref:lnlink</sourcexml></p>
        </section>
        <example>
            <title>Source XML</title>
            <codeblock>

&lt;p&gt;
    &lt;text&gt;
        &lt;dispformula&gt;fee = [(amount to recover for year รท 4) ร
            ( &lt;remotelink dpsi="006A" remotekey1="REFPTID"
                service="DOC-ID"
                refpt="2015R95S3:DESIGNATE_MARKET"
                docidref="2015R95_PRELIMINARY_PROVISIONS"
                &gt;holder&lt;/remotelink&gt; &amp;#x2019;s allocated quantity
            รท total allocated quantity)]&lt;/dispformula&gt;
    &lt;/text&gt;
&lt;/p&gt;

            </codeblock>
            <title>Target XML</title>
            <codeblock>

&lt;p&gt;
    &lt;text&gt;
        &lt;formula&gt;fee = [(amount to recover for year &amp;#x00F7; 4) &amp;#x00D7;
            ( &lt;ref:lnlink service="DOCUMENT"&gt;
  &lt;ref:marker&gt;holder&lt;/ref:marker&gt;
  &lt;ref:locator anchoridref="2015R95S3:DESIGNATE_MARKET"&gt;
    &lt;ref:locator-key&gt;
      &lt;ref:key-name name="DOC-ID"/&gt;
      &lt;ref:key-value value="006A-2015R95_PRELIMINARY_PROVISIONS"/&gt;
    &lt;/ref:locator-key&gt;
  &lt;/ref:locator&gt;
&lt;/ref:lnlink&gt; &amp;#x2019;s allocated quantity &amp;#x00F7; total allocated quantity)]&lt;/formula&gt;
    &lt;/text&gt;
&lt;/p&gt;

            </codeblock>
        </example>
        <section>
            <title>Changes</title>
            <p>2015-08-20: Created.</p>
        </section>
    </body>
	</dita:topic>

	<!--  @@@ This file has been autogenerated.  Remove this comment after manual development complete! @@@  -->
	<!--    Original DITA file location:  DITA\ConversionInstructions\Rosetta\common_newest\Rosetta_remotelink-Chof-dispformula-LxAdv-formula-reflnlink.dita  -->

    <!-- <xsl:template match="dispforumula">
        <forumla xmlns="http://www.lexisnexis.com/xmlschemas/content/shared/base/1/">
            <xsl:apply-templates select="@* | node()"/>
        </forumla>
    </xsl:template> -->

    <!-- dispformula/remotelink[@service="DOC-ID"] becomes a ref:lnlink[@service="DOCUMENT"]. -->
    <!-- 20170619:  MCJ:  needed to force the priority on this because it was conflicting with others related to remotelink.  This implementation might not be complete yet. -->
    <xsl:template match="dispformula/remotelink[@service='DOC-ID']" priority="45">
        <!-- might be better off with a moded-template... but trying a named template as a way of abstracting the creation of a ref:lnlink. -->
        <xsl:call-template name="createDocumentRefLNLinkFromRemoteLink">
            <xsl:with-param name="rlink" select="." />
        </xsl:call-template>
    </xsl:template>

    <!-- externalized the creation of a ref:lnlink[@service='DOCUMENT'] from a remotelink in the hopes to be able to make it available to other modules.  As of now, it needs to be
         local to this module as we shouldn't create dependencies between modules due to the location of a named template. -->
    <!-- this might be better off as a moded template. -->
    <xsl:template name="createDocumentRefLNLinkFromRemoteLink">
        <xsl:param name="rlink" />
        <ref:lnlink service="DOCUMENT">
            <ref:marker><xsl:apply-templates select="$rlink/node()" /></ref:marker>
            <ref:locator>
                <xsl:if test="$rlink/@refpt">
                    <xsl:attribute name="anchoridref">
                        <xsl:value-of select="$rlink/@refpt" />
                    </xsl:attribute>
                </xsl:if>
                <ref:locator-key>
                    <ref:key-name name="DOC-ID" />
                    <xsl:variable name="kv">
                        <xsl:choose>
                            <xsl:when test="$rlink/@remotekey1='DOC-ID' or $rlink/@remotekey='DOCID'">
                                <xsl:value-of select="concat($rlink/@dpsi, '-', $rlink/@remotelink2)" />
                            </xsl:when>
                            <xsl:when test="$rlink/@remotekey1='REFPTID'">
                                <xsl:value-of select="concat($rlink/@dpsi, '-', $rlink/@docidref)" />
                            </xsl:when>
                        </xsl:choose>
                    </xsl:variable>
                    <ref:key-value value="{$kv}" />
                </ref:locator-key>
            </ref:locator>
        </ref:lnlink>
    </xsl:template>



	<!-- <xsl:template match="dispformula/remotelink">

		...  Original Target XPath:  formula/ref:lnlink   ...
		<formula>
			<ref:lnlink xmlns:ref="http://www.lexisnexis.com/xmlschemas/content/shared/reference/1/">
				<xsl:apply-templates select="@* | node()"/>
			</ref:lnlink>
		</formula>

	</xsl:template> -->

	<!-- <xsl:template match="remotelink@service=&#34;DOC-ID&#34;">

		...  Original Target XPath:     ...
		...  Could not determine target element or attribute name:  <>  ...			<xsl:apply-templates select="@* | node()"/>
		...  Could not determine target element or attribute name:  </>  ...

	</xsl:template> -->


</xsl:stylesheet>