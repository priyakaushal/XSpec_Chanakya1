<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
	xmlns:dita="http://dita.oasis-open.org/architecture/2005/"
	xmlns:doc="http://www.lexisnexis.com/xmlschemas/content/shared/document-level-metadata/1/"
	xmlns="http://www.lexisnexis.com/xmlschemas/content/shared/base/1/" version="2.0"
	exclude-result-prefixes="#all">

	<dita:topic xmlns="http://dita.oasis-open.org/architecture/2005/" id="CA14_document.highlights">
		<title>Document Highlights become doc:overview <lnpid>id-CA14-35635</lnpid></title>
		<body>
			<section>
				<p>Up to 75 words (any PCDATA text separated by space, punctuation, or newline)
					shall be extracted, to become
						<targetxml>doc:metadata/doc:docinfo/doc:overview[@type="extracted-overview"]/bodytext/p/text</targetxml>,
					as follows:</p>

				<p>
					<b>Scenario - Extract from:</b> highlights, i.e. <!--<targetxml>///seclaw:body/seclaw:digestgrp/seclaw:highlight/p/text</targetxml>-->
					<sourcexml>highlight//p/text</sourcexml> (any descendant PCDATA).</p>
				<p> (See related instruction <xref href="highlight.dita">here</xref>.) </p>

				<p>
					<note>For those documents with multiple highlight, the results should be
						concatenated together separated by EM DASH —, up to 75 total words.</note>
				</p>
			</section>
			<example>
				<title>Scenario - Mapping of Document Highlights from highlight</title>
				<codeblock> &lt;highlight&gt; &lt;l&gt; &lt;li&gt; &lt;lilabel&gt;*&lt;/lilabel&gt;
					&lt;p&gt; &lt;text&gt;Accused convicted of drug offences as legality of police
					search of locked briefcase incident to arrest considered. (R. v. Rochwell,
					&lt;ci:cite&gt;&lt;ci:case&gt;&lt;ci:caseref ID="cref00000003"
					spanref="cspan00000003"&gt; &lt;ci:reporter
					value="OJ"/&gt;&lt;ci:edition&gt;&lt;ci:date year="2012"/&gt;&lt;/ci:edition&gt;
					&lt;ci:refnum
					num="4808"/&gt;&lt;/ci:caseref&gt;&lt;/ci:case&gt;&lt;ci:content&gt; &lt;ci:span
					spanid="cspan00000003"&gt;[2012] O.J. No.
					4808&lt;/ci:span&gt;&lt;/ci:content&gt; &lt;/ci:cite&gt;,
					&lt;ci:cite&gt;&lt;ci:case&gt;&lt;ci:caseref ID="cref00000004"
					spanref="cspan00000004"&gt;&lt;ci:reporter value="ADGN"/&gt;&lt;ci:edition&gt;
					&lt;ci:date year="2012"/&gt;&lt;/ci:edition&gt;&lt;ci:refnum num="407"/&gt;
					&lt;/ci:caseref&gt;&lt;/ci:case&gt;&lt;ci:content&gt; &lt;ci:span
					spanid="cspan00000004"&gt;ADGN/2012-407&lt;/ci:span&gt;&lt;/ci:content&gt;
					&lt;/ci:cite&gt; (S.C.J.))&lt;/text&gt; &lt;/p&gt; &lt;/li&gt; &lt;/l&gt;
					&lt;/highlight&gt; &lt;highlight&gt; &lt;l&gt; &lt;li&gt;
					&lt;lilabel&gt;*&lt;/lilabel&gt; &lt;p&gt; &lt;text&gt;Cocaine found by vehicle
					search of parked rental vehicle excluded under s. 24(2) after search held
					unlawful.&lt;/text&gt; &lt;/p&gt; &lt;/li&gt; &lt;/l&gt; &lt;/highlight&gt; </codeblock>
				<b>becomes</b>
				<codeblock> &lt;doc:metadata&gt; ... &lt;doc:docinfo&gt; ... &lt;doc:overview
					type="extracted-overview"&gt; &lt;bodytext&gt; &lt;p&gt; &lt;text&gt;Accused
					convicted of drug offences as legality of police search of locked briefcase
					incident to arrest considered. (R. v. Rochwell, [2012] O.J. No. 4808,
					ADGN/2012-407 (S.C.J.)) — Cocaine found by vehicle search of parked rental
					vehicle excluded under s. 24(2) after search held unlawful.&lt;/text&gt;
					&lt;/p&gt; &lt;/bodytext&gt; &lt;/doc:overview&gt; ... &lt;/doc:docinfo&gt; ...
					&lt;/doc:metadata&gt; </codeblock>
			</example>
			<section>
				<title>Changes</title>
				<p>2015-04-27: <ph id="change_20150427_jm">New section. New target. Rules to create
						extracted overview. R4.5 RFA #2287.</ph></p>
			</section>
		</body>
	</dita:topic>

	<!--  @@@ This file has been autogenerated.  Remove this comment after manual development complete! @@@  -->
	<!--    Original DITA file location:  DITA\ConversionInstructions\Rosetta\DITA-CAN\CA14-Emerging_Issues\document.highlights-to-doc.overview.dita  -->


	<!-- Vikas Rohilla : Template to match the highlight to doc:overview -->
	<xsl:template match="highlight[not(preceding-sibling::*[1][self::highlight])]" mode="doc-overview">
		<xsl:element name="doc:overview">
			<xsl:attribute name="type">
				<xsl:text>extracted-overview</xsl:text>
			</xsl:attribute>
			<xsl:element name="bodytext">
				<xsl:element name="p">
					<xsl:element name="text">
						<xsl:variable name="concat_string">
							<xsl:for-each select="descendant::p">
								<xsl:apply-templates select="text" mode="concat"/>
								<xsl:text>— </xsl:text>
							</xsl:for-each>
							<xsl:for-each select="following-sibling::highlight/descendant::p">
								<xsl:text>— </xsl:text>
								<xsl:apply-templates select="text" mode="concat"/>
							</xsl:for-each>							
						</xsl:variable>
						<xsl:variable name="final_string">
							<xsl:variable name="stringList" select="tokenize(normalize-space(replace($concat_string,'— — ','— ')), ' ')"/>
							<xsl:for-each select="$stringList">
								<xsl:if test="position() &lt; 76">
									<xsl:value-of select="concat(., ' ')"/>
								</xsl:if>
							</xsl:for-each>
						</xsl:variable>
						<xsl:choose>
							<xsl:when test="ends-with($final_string,'— ')">
								<xsl:value-of select="normalize-space(replace(substring($final_string,1,string-length($final_string)-2),'— ',' — '))"/>
							</xsl:when>
							<xsl:otherwise>
								<xsl:value-of select="normalize-space(replace($final_string,'— ',' — '))"/>
							</xsl:otherwise>
						</xsl:choose>					
					</xsl:element>
				</xsl:element>
			</xsl:element>
		</xsl:element>
	</xsl:template>
	
	<xsl:template match="text" mode="concat">
		<xsl:apply-templates select="node() except child::fnr"/>
	</xsl:template>
	
	
	
</xsl:stylesheet>
